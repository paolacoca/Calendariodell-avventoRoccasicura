<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÑ Giorno 2 ‚Äì Reindeer Runner</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
}

/* CANVAS VERTICALE */
#game {
  display: none;
  margin: 20px auto;
  border: 3px solid #ffd700;
  border-radius: 10px;
  background: url("../img/sfondo_bosco.jpg") center center / cover no-repeat;
  touch-action: none;
}

/* PUNTEGGIO */
#score {
  display: none;
  background: rgba(0,0,0,0.5);
  padding: 8px 16px;
  border-radius: 12px;
  border: 1px solid #ffd700;
  width: fit-content;
  margin: 10px auto;
  font-size: 1.2em;
}

/* START SCREEN */
#start-screen {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(5px);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.start-box {
  background:#fffaf2;
  padding:30px;
  border-radius:20px;
  width:90%;
  max-width:420px;
  border:2px solid #ffd700;
  color:#400000;
  text-align:center;
}

.start-btn {
  width:80%;
  margin-top:12px;
  padding:14px;
  border-radius:30px;
  font-size:1.1em;
  cursor:pointer;
  background:#7b0412;
  color:white;
  border:none;
  font-weight:bold;
}
.start-btn:hover {
  background:#ffd700;
  color:black;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.countdown-number {
  font-size:6rem;
  font-weight:bold;
  color:#ffd700;
  animation: zoomFade 1s ease forwards;
}

@keyframes zoomFade {
  0% {opacity:0; transform:scale(0.4);}
  30% {opacity:1; transform:scale(1);}
  100% {opacity:0; transform:scale(2);}
}

/* FINE GIOCO */
#fine {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter:blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.classifica-box {
  background:#fffaf2;
  padding:25px;
  border-radius:20px;
  width:90%;
  max-width:460px;
  border:2px solid #ffd700;
  color:#400000;
  text-align:center;
  animation: popup .4s ease-out;
}

@keyframes popup {
  from {transform:scale(.7); opacity:0;}
  to {transform:scale(1); opacity:1;}
}

.btn {
  display:inline-block;
  margin-top:15px;
  padding:12px 30px;
  border-radius:30px;
  font-weight:bold;
  cursor:pointer;
  background:#7b0412;
  color:white;
  text-decoration:none;
}
.btn:hover {
  background:#ffd700;
  color:black;
}

table { width:100%; margin-top:15px; }
th,td {
  padding:8px;
  border-bottom:1px solid #d7bb5f;
  text-align:center;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 2 ‚Äì Reindeer Runner</h1>

<div id="start-screen">
  <div class="start-box">
    <p>
      üå≤ Evita gli alberi<br>
      üéÅ Raccogli i regali per fare punti<br>
      ü¶å Tocca lo schermo per saltare<br>
      ‚å®Ô∏è (PC) Space / Click per saltare
    </p>
    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<div id="countdown">
  <div id="countdown-number" class="countdown-number"></div>
</div>

<div id="score">Punteggio: 0</div>
<canvas id="game"></canvas>

<!-- FINE -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>
    <h3>üèÜ Top 10 Globale</h3>

    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>

<audio id="musica" loop>
  <source src="../audio/jingle_bells_instrumental.mp3" type="audio/mpeg">
</audio>

<script>
// --- FIREBASE ---
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

// --- NOME MASCHERATO ---
const nome = localStorage.getItem("utente") || "Ospite";
const nomeMascherato = nome[0] + Math.floor(Math.random()*900+100) + nome.slice(1);

// --- CANVAS ---
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 450);
  const h = Math.floor(w * 1.25);
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// --- SPRITES ---
const rennaImg = new Image(); rennaImg.src = "../img/renna.png";
const alberoImg = new Image(); alberoImg.src = "../img/albero.png";
const regaloImg = new Image(); regaloImg.src = "../img/gift.png";

// --- GIOCO ---
let renna = { x:60, y:300, w:80, h:80, vy:0, jumping:false };
let alberi = [];
let regali = [];
let score = 0;
let giocoFinito = false;

function jump() {
  if (!renna.jumping) {
    renna.vy = -14;
    renna.jumping = true;
  }
}

window.addEventListener("keydown", e => {
  if (["Space","ArrowUp"].includes(e.code)) jump();
});
canvas.addEventListener("mousedown", jump);
canvas.addEventListener("touchstart", e => { e.preventDefault(); jump(); });

// GENERA ALBERI
function generaAlbero() {
  alberi.push({
    x: canvas.width + 20,
    y: canvas.height - 120,
    w: 60,
    h: 90,
    speed: 2.4
  });
}

// GENERA REGALO
function generaRegalo() {
  regali.push({
    x: canvas.width + 20,
    y: canvas.height - 180,
    w: 50,
    h: 50,
    speed: 2.4
  });
}

// FINE GIOCO
function fineGioco() {
  if (giocoFinito) return;
  giocoFinito = true;

  document.getElementById("messaggio").textContent =
    `Hai raccolto ${score} punti!`;

  db.ref("giorno2").push({
    nome: nomeMascherato,
    punti: score,
    timestamp: Date.now()
  });

  caricaClassifica();
  document.getElementById("fine").style.display = "flex";
}

// CARICA CLASSIFICA
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("giorno2")
    .once("value")
    .then(snapshot => {
      let arr = [];

      snapshot.forEach(ch => arr.push(ch.val()));
      arr.sort((a,b) => b.punti - a.punti);
      arr = arr.slice(0,10);

      arr.forEach(r => {
        table.innerHTML += `<tr><td>${r.nome}</td><td>${r.punti}</td></tr>`;
      });
    });
}

// GAME LOOP
function gameLoop() {
  if (giocoFinito) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Gravit√†
  renna.y += renna.vy;
  renna.vy += 0.8;

  const terreno = canvas.height - 130;
  if (renna.y > terreno) {
    renna.y = terreno;
    renna.vy = 0;
    renna.jumping = false;
  }

  // Disegna renna
  ctx.drawImage(rennaImg, renna.x, renna.y, renna.w, renna.h);

  // ALBERI
  alberi.forEach((a,i)=>{
    a.x -= a.speed;
    ctx.drawImage(alberoImg, a.x, a.y, a.w, a.h);

    if (renna.x < a.x + a.w &&
        renna.x + renna.w > a.x &&
        renna.y < a.y + a.h &&
        renna.y + renna.h > a.y) {
      fineGioco();
    }

    if (a.x + a.w < 0) alberi.splice(i,1);
  });

  // REGALI
  regali.forEach((g,i)=>{
    g.x -= g.speed;
    ctx.drawImage(regaloImg, g.x, g.y, g.w, g.h);

    if (renna.x < g.x + g.w &&
        renna.x + renna.w > g.x &&
        renna.y < g.y + g.h &&
        renna.y + renna.h > g.y) {
      score += 10;
      document.getElementById("score").textContent =
        "Punteggio: " + score;
      regali.splice(i,1);
    }

    if (g.x + g.w < 0) regali.splice(i,1);
  });

  requestAnimationFrame(gameLoop);
}

// COUNTDOWN
function startCountdown(callback) {
  const box = document.getElementById("countdown");
  const num = document.getElementById("countdown-number");
  let n = 3;

  box.style.display = "flex";
  num.textContent = n;

  const i = setInterval(()=>{
    n--;
    if (n > 0) {
      num.textContent = n;
      num.classList.remove("countdown-number");
      void num.offsetWidth;
      num.classList.add("countdown-number");
    } else {
      num.textContent = "VIA!";
      setTimeout(()=>{
        clearInterval(i);
        box.style.display = "none";
        callback();
      },500);
    }
  },1000);
}

// AVVIO GIOCO
function avviaGioco() {
  resizeCanvas();
  canvas.style.display = "block";
  document.getElementById("score").style.display = "block";

  const musica = document.getElementById("musica");
  musica.play().catch(()=>{});

  setInterval(()=>{ if(!giocoFinito) generaAlbero(); }, 1500);
  setInterval(()=>{ if(!giocoFinito) generaRegalo(); }, 2200);

  gameLoop();
}

// EVENTI UI
document.getElementById("btn-start").onclick = () => {
  document.getElementById("start-screen").style.display="none";
  startCountdown(avviaGioco);
};

document.getElementById("retry-btn").onclick = () => location.reload();

document.getElementById("btn-top10").onclick = () => {
  document.getElementById("start-screen").style.display="none";
  caricaClassifica();
  document.getElementById("fine").style.display="flex";
};
</script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

</body>
</html>


