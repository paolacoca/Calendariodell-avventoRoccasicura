<script>
/* ============================================
   FIREBASE
============================================ */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

/* ============================================
   USER MASK
============================================ */
const nomeReale = localStorage.getItem("utente") || "Ospite";
const nomeMascherato =
  nomeReale[0] + Math.floor(Math.random()*900+100) + nomeReale.slice(1);

/* ============================================
   CANVAS
============================================ */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 450);
  const h = Math.floor(w * 1.25);
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ============================================
   IMMAGINI
============================================ */
const rennaImg = new Image();
const alberoImg = new Image();
const giftImg = new Image();
const giftGoldImg = new Image();

/* ============================================
   PRELOAD DURANTE COUNTDOWN
============================================ */
let preloadOk = false;

function preloadAssets(callback) {
  let loaded = 0;
  const total = 4;

  function done() {
    loaded++;
    if (loaded >= total) {
      preloadOk = true;
      callback();
    }
  }

  rennaImg.onload = done;
  alberoImg.onload = done;
  giftImg.onload = done;
  giftGoldImg.onload = done;

  rennaImg.src = "../img/renna.png";
  alberoImg.src = "../img/albero.png";
  giftImg.src = "../img/gift.png";
  giftGoldImg.src = "../img/gift_gold.png";
}

/* ============================================
   PARAMETRI
============================================ */
const V_OSTACOLI = 2.2;
const V_REGALI = 2.2;
const V_NEVE = 1;
const V_GRAV = 0.55;

let renna = { x: 40, y: 0, w: 80, h: 80, vy: 0 };
let ostacoli = [];
let regali = [];
let fiocchi = [];
let punteggio = 0;
let vite = 3;
let pulsante = false;
let finito = false;

/* ============================================
   CONTROLLI
============================================ */
canvas.addEventListener("touchstart", e => { e.preventDefault(); pulsante = true; });
canvas.addEventListener("touchend",   () => pulsante = false);

canvas.addEventListener("mousedown", () => pulsante = true);
canvas.addEventListener("mouseup",   () => pulsante = false);

window.addEventListener("keydown", e => {
  if (["Space","ArrowUp"].includes(e.code)) pulsante = true;
});
window.addEventListener("keyup", e => {
  if (["Space","ArrowUp"].includes(e.code)) pulsante = false;
});

/* ============================================
   GENERA OSTACOLI
============================================ */
let ultimoOstacolo = Date.now();
function generaOstacolo() {
  const ora = Date.now();
  if (ora - ultimoOstacolo < 1700) return;

  ostacoli.push({
    x: canvas.width + 20,
    y: canvas.height - 140,
    w: 60,
    h: 90
  });

  ultimoOstacolo = ora;
}
setInterval(generaOstacolo, 50);

/* ============================================
   GENERA REGALI
============================================ */
function generaRegalo() {
  const speciale = Math.random() < 0.12;
  regali.push({
    x: canvas.width + 20,
    y: canvas.height - (160 + Math.random()*60),
    w: speciale ? 55 : 45,
    h: speciale ? 55 : 45,
    oro: speciale
  });
}
setInterval(generaRegalo, 1900);

/* ============================================
   NEVE
============================================ */
function generaFiocco() {
  fiocchi.push({
    x: Math.random() * canvas.width,
    y: -10,
    r: Math.random()*2 + 1,
    v: Math.random()*1.2 + 0.4
  });
}
setInterval(generaFiocco, 120);

/* ============================================
   FINE GIOCO  (posizionata PRIMA del gameLoop)
============================================ */
function fineGioco() {
  if (finito) return;
  finito = true;

  document.getElementById("fine").style.display = "flex";
  document.getElementById("messaggio").textContent =
    `Hai totalizzato ${punteggio} punti!`;

  db.ref("punteggi/giorno2").push({
    nome: nomeMascherato,
    punti: punteggio,
    timestamp: Date.now()
  });

  caricaClassifica();
}

/* ============================================
   CLASSIFICA
============================================ */
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno2")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {
      let arr = [];
      snap.forEach(child => arr.push(child.val()));
      arr.sort((a,b)=>b.punti - a.punti);

      arr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* ============================================
   GAME LOOP
============================================ */
function gameLoop() {
  if (finito) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (pulsante) renna.vy = -5.2;
  else renna.vy += V_GRAV;

  renna.y += renna.vy;

  if (renna.y < 20) renna.y = 20;
  const terreno = canvas.height - 150;
  if (renna.y > terreno) renna.y = terreno;

  ctx.drawImage(rennaImg, renna.x, renna.y, renna.w, renna.h);

  /* ALBERI */
  for (let i = ostacoli.length - 1; i >= 0; i--) {
    const o = ostacoli[i];
    o.x -= V_OSTACOLI;

    ctx.drawImage(alberoImg, o.x, o.y, o.w, o.h);

    const hit =
      renna.x + 20 < o.x + o.w &&
      renna.x + renna.w - 20 > o.x &&
      renna.y + 20 < o.y + o.h &&
      renna.y + renna.h - 20 > o.y;

    if (hit) {
      ostacoli.splice(i,1);
      vite--;
      if (vite <= 0) return fineGioco();

      document.getElementById("punteggio").textContent =
        `Punteggio: ${punteggio} | ❤️ ${vite}`;
      continue;
    }

    if (o.x + o.w < 0) ostacoli.splice(i,1);
  }

  /* REGALI */
  for (let i = regali.length - 1; i >= 0; i--) {
    const g = regali[i];
    g.x -= V_REGALI;

    ctx.drawImage(g.oro ? giftGoldImg : giftImg, g.x, g.y, g.w, g.h);

    const preso =
      renna.x < g.x + g.w &&
      renna.x + renna.w > g.x &&
      renna.y < g.y + g.h &&
      renna.y + renna.h > g.y;

    if (preso) {
      punteggio += g.oro ? 50 : 10;
      document.getElementById("punteggio").textContent =
        `Punteggio: ${punteggio} | ❤️ ${vite}`;
      regali.splice(i,1);
      continue;
    }

    if (g.x + g.w < 0) regali.splice(i,1);
  }

  /* NEVE */
  for (let i = fiocchi.length - 1; i >= 0; i--) {
    const f = fiocchi[i];
    f.y += f.v;

    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
    ctx.fill();

    if (f.y > canvas.height) fiocchi.splice(i,1);
  }

  requestAnimationFrame(gameLoop);
}

/* ============================================
   COUNTDOWN CON PRELOAD
============================================ */
function startCountdown(onFinish) {
  const c = document.getElementById("countdown");
  const num = document.getElementById("countdown-number");

  let n = 3;
  c.style.display = "flex";
  num.textContent = n;

  preloadAssets(() => {
    console.log("✔ Tutte le immagini pronte prima del VIA!");
  });

  const timer = setInterval(() => {
    n--;

    if (n > 0) {
      num.textContent = n;
    } else {
      num.textContent = "VIA!";
      setTimeout(() => {
        clearInterval(timer);
        c.style.display = "none";

        const wait = setInterval(() => {
          if (preloadOk) {
            clearInterval(wait);
            onFinish();
          }
        }, 30);

      }, 500);
    }
  }, 1000);
}

/* ============================================
   START GAME
============================================ */
function iniziaGioco() {
  canvas.style.display = "block";
  document.getElementById("punteggio").style.display = "block";
  gameLoop();
}

document.getElementById("btn-start").addEventListener("click", () => {
  document.getElementById("start-screen").style.display = "none";

  const musica = document.getElementById("musica");
  musica.currentTime = 0;
  musica.play().catch(()=>{});

  startCountdown(iniziaGioco);
});

/* CLASSIFICA */
document.getElementById("btn-top10").addEventListener("click", () => {
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  caricaClassifica();
});

/* RIPROVA */
document.getElementById("retry-btn").addEventListener("click", () => {
  location.reload();
});
</script>
