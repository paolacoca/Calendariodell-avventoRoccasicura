<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéÑ Giorno 2 ‚Äì Reindeer Runner</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
}

/* CANVAS */
canvas {
  display: none;
  margin: 20px auto;
  border: 3px solid #ffd700;
  border-radius: 10px;
  background: url("../img/sfondo_bosco.jpg") center center / cover no-repeat;
  touch-action: none;
}

/* Punteggio */
#punteggio {
  display: none;
  margin-top: 10px;
  padding: 6px 14px;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  border: 1px solid #ffd700;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
  font-size: 1.2em;
}

/* START SCREEN */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 420px;
  border: 2px solid #ffd700;
  color: #400000;
}

.start-btn {
  width: 80%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.1em;
  cursor: pointer;
  background: #7b0412;
  color: white;
  border: none;
  font-weight: bold;
}

.start-btn:hover {
  background: #ffd700;
  color: #400000;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
  animation: zoomFade 1s ease forwards;
}

@keyframes zoomFade {
  0% { opacity: 0; transform: scale(0.4); }
  30% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(2); }
}

/* FINE GIOCO */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.btn {
  display: inline-block;
  margin-top: 15px;
  padding: 12px 30px;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  color: white;
  background: #7b0412;
  text-decoration: none;
}

.btn:hover {
  background: #ffd700;
  color: #400000;
}

table { width: 100%; margin-top: 15px; }
th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 2 ‚Äì Reindeer Runner</h1>
<div id="punteggio">Punteggio: 0 | ‚ù§Ô∏è 3</div>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">
    <p>
      üå≤ Evita gli alberi<br>
      üéÅ Regali comuni (+10)<br>
      ‚≠ê Regali d‚Äôoro (+50)<br>
      ‚ù§Ô∏è 3 vite<br>
      ü¶å Tieni premuto per salire<br>
      ‚ùÑ Neve che cade<br>
      üì± Perfetto per telefono!
    </p>
    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<!-- COUNTDOWN -->
<div id="countdown">
  <div id="countdown-number" class="countdown-number">3</div>
</div>

<!-- GAME -->
<canvas id="game"></canvas>

<!-- FINE -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>

    <h3>üèÜ Top 10 Globale</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>

<audio id="musica" loop>
  <source src="../audio/jingle_bells_instrumental.mp3" type="audio/mpeg">
</audio>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

/* ===== USER MASK ===== */
const nomeReale = localStorage.getItem("utente") || "Ospite";
const nomeMascherato =
  nomeReale[0] + Math.floor(Math.random()*900+100) + nomeReale.slice(1);

/* ===== CANVAS ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 450);
  const h = Math.floor(w * 1.25);
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ===== IMMAGINI ===== */
const rennaImg = new Image(); rennaImg.src = "../img/renna.png";
const alberoImg = new Image(); alberoImg.src = "../img/albero.png";
const giftImg = new Image(); giftImg.src = "../img/gift.png";
const giftGoldImg = new Image(); giftGoldImg.src = "../img/gift_gold.png";

/* ===== PARAMETRI ===== */
const VELOCITA_OSTACOLI = 2;
const VELOCITA_REGALI = 2;
const VELOCITA_GRAVITA = 0.55;

let renna = {
  x: 40,
  y: 0,
  w: 80,
  h: 80,
  vy: 0
};

let ostacoli = [];
let regali = [];
let fiocchi = [];
let punteggioTotale = 0;
let vite = 3;
let giocoTerminato = false;
let pulsantePremuto = false;

/* ===== CONTROLLI ===== */
canvas.addEventListener("touchstart", e => { e.preventDefault(); pulsantePremuto = true; });
canvas.addEventListener("touchend", () => pulsantePremuto = false);
canvas.addEventListener("mousedown", () => pulsantePremuto = true);
canvas.addEventListener("mouseup", () => pulsantePremuto = false);

window.addEventListener("keydown", e => {
  if (["Space", "ArrowUp"].includes(e.code)) pulsantePremuto = true;
});
window.addEventListener("keyup", e => {
  if (["Space", "ArrowUp"].includes(e.code)) pulsantePremuto = false;
});

/* ===== GENERA OSTACOLI DISTANZIATI ===== */
let ultimoSpawn = Date.now();

function generaOstacolo() {
  const ora = Date.now();
  const distanzaMinimaTempo = 1800; // minimo 1.8s tra un ostacolo e l‚Äôaltro

  if (ora - ultimoSpawn < distanzaMinimaTempo) return;

  ostacoli.push({
    x: canvas.width + 20,
    y: canvas.height - 140,
    w: 60,
    h: 90
  });

  ultimoSpawn = ora;
}
setInterval(generaOstacolo, 50);

/* ===== GENERA REGALI ===== */
function generaRegalo() {
  const speciale = Math.random() < 0.10;

  regali.push({
    x: canvas.width + 20,
    y: canvas.height - (160 + Math.random()*50),
    w: speciale ? 55 : 45,
    h: speciale ? 55 : 45,
    speciale: speciale
  });
}
setInterval(generaRegalo, 1900);

/* ===== NEVE ===== */
function generaFiocco() {
  fiocchi.push({
    x: Math.random() * canvas.width,
    y: -10,
    r: Math.random() * 2 + 1,
    v: Math.random() * 1.2 + 0.3
  });
}
setInterval(generaFiocco, 120);

/* ===== FINE ===== */
function fineGioco() {
  if (giocoTerminato) return;
  giocoTerminato = true;

  document.getElementById("fine").style.display = "flex";
  document.getElementById("messaggio").textContent =
    `Hai totalizzato ${punteggioTotale} punti!`;

  db.ref("punteggi/giorno2").push({
    nome: nomeMascherato,
    punti: punteggioTotale,
    timestamp: Date.now()
  });

  caricaClassifica();
}

/* ===== CLASSIFICA ===== */
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno2")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snapshot => {

      let arr = [];
      snapshot.forEach(ch => {
        const v = ch.val();
        arr.push({
          nome: v.nome,
          punti: Number(v.punti)
        });
      });

      arr.sort((a,b)=>b.punti - a.punti);

      arr.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* ===== GAME LOOP ===== */
function gameLoop() {
  if (giocoTerminato) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* Movimento verticale (jetpack) */
  if (pulsantePremuto) {
    renna.vy = -5.2;     // salita costante
  } else {
    renna.vy += VELOCITA_GRAVITA; // gravit√†
  }

  renna.y += renna.vy;

  /* Limite superiore */
  const limiteSuperiore = 30;
  if (renna.y < limiteSuperiore) {
    renna.y = limiteSuperiore;
    renna.vy = 0;
  }

  /* Terreno */
  const terreno = canvas.height - 150;
  if (renna.y > terreno) {
    renna.y = terreno;
    renna.vy = 0;
  }

  ctx.drawImage(rennaImg, renna.x, renna.y, renna.w, renna.h);

  /* ALBERI */
  ostacoli.forEach((o,i)=>{
    o.x -= VELOCITA_OSTACOLI;
    ctx.drawImage(alberoImg, o.x, o.y, o.w, o.h);

    // collisione
    if (
      renna.x + 20 < o.x + o.w &&
      renna.x + renna.w - 20 > o.x &&
      renna.y + 20 < o.y + o.h &&
      renna.y + renna.h - 20 > o.y
    ) {
      ostacoli.splice(i,1);
      vite--;

      if (vite <= 0) {
        fineGioco();
      }

      document.getElementById("punteggio").textContent =
        `Punteggio: ${punteggioTotale} | ‚ù§Ô∏è ${vite}`;
    }

    if (o.x + o.w < 0) ostacoli.splice(i,1);
  });

  /* REGALI */
  regali.forEach((g,i)=>{
    g.x -= VELOCITA_REGALI;
    ctx.drawImage(
      g.speciale ? giftGoldImg : giftImg,
      g.x, g.y, g.w, g.h
    );

    if (
      renna.x < g.x + g.w &&
      renna.x + renna.w > g.x &&
      renna.y < g.y + g.h &&
      renna.y + renna.h > g.y
    ) {
      punteggioTotale += g.speciale ? 50 : 10;

      document.getElementById("punteggio").textContent =
        `Punteggio: ${punteggioTotale} | ‚ù§Ô∏è ${vite}`;

      regali.splice(i,1);
    }

    if (g.x + g.w < 0) regali.splice(i,1);
  });

  /* NEVE */
  fiocchi.forEach((f,i)=>{
    f.y += f.v;
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
    ctx.fill();
    if (f.y > canvas.height) fiocchi.splice(i,1);
  });

  requestAnimationFrame(gameLoop);
}

/* ===== COUNTDOWN ===== */
function startCountdown(callback) {
  const c = document.getElementById("countdown");
  const num = document.getElementById("countdown-number");

  let n = 3;
  c.style.display = "flex";
  num.textContent = n;

  const interval = setInterval(()=>{
    n--;
    if (n > 0) {
      num.textContent = n;
      num.classList.remove("countdown-number");
      void num.offsetWidth;
      num.classList.add("countdown-number");
    } else {
      num.textContent = "VIA!";
      setTimeout(()=>{
        c.style.display = "none";
        clearInterval(interval);
        callback();
      },600);
    }
  },1000);
}

/* ===== START GAME ===== */
function iniziaGioco() {
  canvas.style.display = "block";
  document.getElementById("punteggio").style.display = "block";
  gameLoop();
}

document.getElementById("btn-start").addEventListener("click", ()=>{
  document.getElementById("start-screen").style.display = "none";

  const musica = document.getElementById("musica");
  musica.currentTime = 0;
  musica.play().catch(()=>{});

  startCountdown(iniziaGioco);
});

/* TOP 10 */
document.getElementById("btn-top10").addEventListener("click", ()=>{
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  caricaClassifica();
});

/* RIPROVA */
document.getElementById("retry-btn").addEventListener("click", ()=>{
  location.reload();
});
</script>

</body>
</html>
