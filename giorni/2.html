<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéÑ Giorno 2 ‚Äì Reindeer Runner</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
/* =====================================================================
   üé® STILE GENERALE DELLA PAGINA
   ===================================================================== */
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
}

/* =====================================================================
   üñºÔ∏è CANVAS DI GIOCO ‚Äî responsive
   ===================================================================== */
canvas {
  display: none;
  margin: 20px auto;
  border: 3px solid #ffd700;
  border-radius: 10px;
  background: url("../img/sfondo_bosco.jpg") center center / contain no-repeat;
  touch-action: none;
}

/* =====================================================================
   üìè INFO distanza in basso
   ===================================================================== */
.info {
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.50);
  padding: 8px 16px;
  border-radius: 12px;
  border: 1px solid #ffd700;
  z-index: 40;
}

/* =====================================================================
   ‚ñ∂Ô∏è SCHERMATA INIZIALE ‚Äî stile uguale a Giorno 1
   ===================================================================== */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.60);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 420px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

/* Pulsanti identici al Giorno 1 */
.start-btn {
  width: 80%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.1em;
  cursor: pointer;
  background: #7b0412;
  color: white;
  border: none;
  font-weight: bold;
}
.start-btn:hover {
  background: #ffd700;
  color: black;
}

/* =====================================================================
   üì± SCHERMATA "RUOTA IL DISPOSITIVO"
   ===================================================================== */
#rotate-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.rotate-box {
  background: #fffaf2;
  border: 2px solid #ffd700;
  border-radius: 20px;
  padding: 30px;
  width: 90%;
  max-width: 360px;
  text-align: center;
  color: #400000;
  font-size: 1.2em;
  line-height: 1.5;
  animation: fadeIn .6s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}

/* =====================================================================
   ‚è± COUNTDOWN 3 ‚Äì 2 ‚Äì 1 ‚Äì VIA
   ===================================================================== */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.50);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
  animation: zoomFade 1s ease forwards;
}

@keyframes zoomFade {
  0%   { opacity: 0; transform: scale(0.4); }
  30%  { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(2); }
}

/* =====================================================================
   üèÅ FINE GIOCO ‚Äî finestra identica a Giorno 1
   ===================================================================== */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  animation: popup .4s ease-out;
  text-align: center;
}

@keyframes popup {
  from { transform: scale(.7); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

.btn {
  display: inline-block;
  margin-top: 15px;
  padding: 12px 30px;
  border-radius: 30px;
  font-weight: bold;
  text-decoration: none;
  cursor: pointer;
  color: #fff;
  background: #7b0412;
  transition: .3s;
}
.btn:hover {
  background: #ffd700;
  color: black;
}

table { width: 100%; margin-top: 15px; }
th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 2 ‚Äì Reindeer Runner</h1>

<!-- ‚ñ∂Ô∏è SCHERMATA INIZIALE -->
<div id="start-screen">
  <div class="start-box">
    <p>
      üå≤ Evita gli alberi<br>
      ü¶å Premi per saltare<br>
      ‚ú® Salto lungo fino a 15 secondi<br>
      ‚òÅ Nuvola dopo 10s di volo reale
    </p>
    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<!-- üì± RUOTA DISPOSITIVO -->
<div id="rotate-screen">
  <div class="rotate-box">
    üì± <br>
    <strong>Ruota il dispositivo!</strong><br>
    Il gioco funziona solo in orizzontale.
  </div>
</div>

<!-- COUNTDOWN 3-2-1 -->
<div id="countdown">
  <div id="countdown-number" class="countdown-number">3</div>
</div>

<!-- CANVAS -->
<canvas id="game"></canvas>
<div class="info" id="info">Distanza: 0m</div>

<!-- FINE GIOCO -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>
    <h3>üèÜ Top 10 Globale</h3>

    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>

<!-- AUDIO -->
<audio id="musica" loop>
  <source src="../audio/jingle_bells_instrumental.mp3" type="audio/mpeg">
</audio>


















<script>
/* ================================================================
   üî• FIREBASE CONFIG
   ================================================================ */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

/* ================================================================
   üë§ NOME MASCHERATO
   ================================================================ */
const nomeReale = localStorage.getItem("utente") || "Ospite";
const nomeMascherato =
  nomeReale[0] + Math.floor(Math.random()*900+100) + nomeReale.slice(1);

/* ================================================================
   üéÆ CANVAS E SPRITES
   ================================================================ */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  if (window.innerWidth < 700) {
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight * 0.50;
  } else {
    canvas.width = 900;
    canvas.height = 500;
  }
}

resizeCanvas();
window.addEventListener("resize", resizeCanvas);

const rennaImg = new Image(); rennaImg.src = "../img/renna.png";
const alberoImg = new Image(); alberoImg.src = "../img/albero.png";
const cloudImg  = new Image(); cloudImg.src  = "../img/cloud.png";

/* ================================================================
   ü¶å GIOCATORE (RENNA)
   ================================================================ */
let renna = {
  x: 120,
  y: 300,
  w: 110,
  h: 110,
  vy: 0,
  jumping: false
};

let distanza = 0;
let saltoLungo = false;
let tempoVoloReale = 0;

let ostacoli = [];
let stopAlberi = false;

let nuvola = null;
let nuvolaAttiva = false;

let giocoTerminato = false;

/* ================================================================
   üéÆ INPUT ‚Äî salto lungo 15s
   ================================================================ */
function jump() {
  if (!renna.jumping) {
    renna.vy = -16;
    renna.jumping = true;
    tempoVoloReale = 0;  // reset timer volo reale
  }
}

window.addEventListener("keydown", e => {
  if (["Space", "ArrowUp"].includes(e.code)) {
    saltoLungo = true;
    jump();
  }
});
window.addEventListener("keyup", () => saltoLungo = false);

canvas.addEventListener("mousedown", () => {
  saltoLungo = true;
  jump();
});
canvas.addEventListener("mouseup", () => saltoLungo = false);

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  saltoLungo = true;
  jump();
});
canvas.addEventListener("touchend", () => saltoLungo = false);

/* ================================================================
   üå≤ OSTACOLI ‚Äî ALBERI
   ================================================================ */
function generaOstacolo() {
  if (stopAlberi || nuvolaAttiva) return;

  ostacoli.push({
    x: canvas.width + 20,
    y: canvas.height - 120,
    w: 70,
    h: 100
  });
}

function gestisciOstacoli() {
  if (ostacoli.length === 0) generaOstacolo();

  const ultimo = ostacoli[ostacoli.length - 1];
  if (ultimo.x < canvas.width - 650) generaOstacolo();
}

/* ================================================================
   ‚òÅÔ∏è NUVOLA ‚Äî da destra verso sinistra (lenta)
   ================================================================ */
function generaNuvola() {
  nuvola = {
    x: canvas.width + 60,
    y: canvas.height * 0.18,
    w: 120,
    h: 85,
    speed: 1.8 // <<< velocit√† pi√π lenta
  };

  nuvolaAttiva = true;
  stopAlberi = true;

  // dopo 5 secondi gli alberi ricominciano
  setTimeout(() => stopAlberi = false, 5000);
}

function disegnaNuvola() {
  if (!nuvolaAttiva) return;

  nuvola.x -= nuvola.speed;
  ctx.drawImage(cloudImg, nuvola.x, nuvola.y, nuvola.w, nuvola.h);

  // collisione nuvola = fine gioco
  if (
    renna.x < nuvola.x + nuvola.w &&
    renna.x + renna.w > nuvola.x &&
    renna.y < nuvola.y + nuvola.h &&
    renna.y + renna.h > nuvola.y
  ) {
    fineGioco();
  }

  // sparita fuori schermo
  if (nuvola.x + nuvola.w < 0) nuvolaAttiva = false;
}










/* ================================================================
   üèÅ FINE GIOCO
   ================================================================ */
function fineGioco() {
  if (giocoTerminato) return;
  giocoTerminato = true;

  document.getElementById("fine").style.display = "flex";
  document.getElementById("messaggio").textContent =
    `Hai percorso ${Math.floor(distanza)} metri!`;

  // Salva su Firebase
  db.ref("giorno2").push({
    nome: nomeMascherato,
    punti: Math.floor(distanza),
    timestamp: Date.now()
  });

  caricaClassifica();
}

/* ================================================================
   üèÜ CLASSIFICA
   ================================================================ */
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("giorno2")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {
      let arr = [];
      snap.forEach(s => arr.push(s.val()));
      arr.sort((a, b) => b.punti - a.punti);

      arr.forEach(r => {
        table.innerHTML += `<tr><td>${r.nome}</td><td>${r.punti}</td></tr>`;
      });
    });
}

/* ================================================================
   üßä FREEZE DETECTOR
   ================================================================ */
let lastDistance = 0;
let freezeTimer = 0;

function controllaFreeze() {
  if (giocoTerminato) return;

  if (Math.floor(distanza) === Math.floor(lastDistance)) {
    freezeTimer++;

    // 90 frame ‚âà 1.5 secondi
    if (freezeTimer > 90) {
      fineGioco();
    }
  } else {
    freezeTimer = 0;
  }

  lastDistance = distanza;
}

/* ================================================================
   üîÅ GAME LOOP FINALE
   ================================================================ */
function gameLoop() {

  if (giocoTerminato) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* ‚è± TEMPO DI VOLO REALE */
  if (renna.jumping && !nuvolaAttiva) {
    tempoVoloReale += 1/60;

    if (saltoLungo && tempoVoloReale < 15) {
      renna.vy = -6;
    }
  }

  /* ‚òÅÔ∏è NUVOLA DOPO 10 SECONDI REALI IN ARIA */
  if (!nuvolaAttiva && tempoVoloReale >= 10) {
    generaNuvola();
  }

  /* ‚öôÔ∏è FISICA GRAVIT√Ä */
  renna.y += renna.vy;
  renna.vy += 0.8;

  /* üîº LIMITE ALTO (tetto fisico) */
  const limiteAlto = canvas.height * 0.05;

  if (renna.y < limiteAlto) {
    renna.y = limiteAlto;
    renna.vy = 1;   // rimbalzo verso il basso
    renna.jumping = true;
  }

  /* üîΩ TERRA */
  const terreno = canvas.height - 150;

  if (renna.y > terreno) {
    renna.y = terreno;
    renna.vy = 0;
    renna.jumping = false;
    tempoVoloReale = 0;  // reset solo quando tocchi terra
    nuvolaAttiva = false;
  }

  /* ü¶å DISEGNA RENNA */
  ctx.drawImage(rennaImg, renna.x, renna.y, renna.w, renna.h);

  /* ‚òÅÔ∏è DISEGNA NUVOLA */
  disegnaNuvola();

  /* üå≤ OSTACOLI */
  gestisciOstacoli();
  ostacoli.forEach((o, i) => {
    o.x -= 6;
    ctx.drawImage(alberoImg, o.x, o.y - 30, o.w, o.h);

    // collisione
    if (
      renna.x < o.x + o.w &&
      renna.x + renna.w > o.x &&
      renna.y < o.y + o.h &&
      renna.y + renna.h > o.y
    ) {
      fineGioco();
    }

    if (o.x + o.w < 0) ostacoli.splice(i, 1);
  });

  /* üìè DISTANZA */
  distanza += 0.30;
  document.getElementById("info").textContent =
    `Distanza: ${Math.floor(distanza)}m`;

  /* üßä Controllo freeze */
  controllaFreeze();

  requestAnimationFrame(gameLoop);
}

/* ================================================================
   üì± CONTROLLO ORIENTAMENTO
   ================================================================ */
function isVertical() {
  return window.innerHeight > window.innerWidth;
}

function mostraRotate() {
  document.getElementById("rotate-screen").style.display = "flex";
}

function nascondiRotate() {
  document.getElementById("rotate-screen").style.display = "none";
}

/* ================================================================
   ‚è± COUNTDOWN 3‚Äì2‚Äì1‚ÄìVIA
   ================================================================ */
function avviaCountdown(callback) {
  const ctn = document.getElementById("countdown");
  const num = document.getElementById("countdown-number");

  let n = 3;
  ctn.style.display = "flex";
  num.textContent = n;

  const interval = setInterval(() => {
    n--;
    if (n > 0) {
      num.textContent = n;
      num.classList.remove("countdown-number");
      void num.offsetWidth;
      num.classList.add("countdown-number");
    } else {
      num.textContent = "VIA!";
      num.classList.remove("countdown-number");
      void num.offsetWidth;
      num.classList.add("countdown-number");

      setTimeout(() => {
        ctn.style.display = "none";
        clearInterval(interval);
        callback();
      }, 800);
    }
  }, 1000);
}

/* ================================================================
   üöÄ AVVIO DEL GIOCO
   ================================================================ */
function iniziaGioco() {

  canvas.style.display = "block";
  resizeCanvas();
  document.getElementById("info").style.display = "block";

  const musica = document.getElementById("musica");
  musica.currentTime = 0;

  musica.play().catch(() => {
    canvas.addEventListener("touchstart", () => musica.play(), { once:true });
    canvas.addEventListener("mousedown", () => musica.play(), { once:true });
  });

  gameLoop();
}

/* ================================================================
   ‚ñ∂Ô∏è START SCHERMATA INIZIALE
   ================================================================ */
document.getElementById("btn-start").onclick = () => {
  document.getElementById("start-screen").style.display = "none";

  if (isVertical()) {
    mostraRotate();
  } else {
    avviaCountdown(iniziaGioco);
  }
};

/* Cambia orientamento */
window.addEventListener("orientationchange", () => {
  if (!isVertical()) {
    nascondiRotate();
    avviaCountdown(iniziaGioco);
  }
});

/* Fallback Android */
window.addEventListener("resize", () => {
  if (!isVertical() &&
      document.getElementById("rotate-screen").style.display !== "none") {
    nascondiRotate();
    avviaCountdown(iniziaGioco);
  }
});

/* ================================================================
   üîÑ RIPROVA + TOP10
   ================================================================ */
document.getElementById("retry-btn").onclick = () => location.reload();

document.getElementById("btn-top10").onclick = () => {
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  caricaClassifica();
};

</script>

