<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚≠ê Giorno 5 ‚Äì Stella Furiosa PRO</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  padding: 0;
  background: #7b0412;
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  text-align: center;
  overflow: hidden;
  height: 100vh;
}

h1 {
  margin-top: 10px;
  color: #ffd700;
}

/* CANVAS */
canvas {
  display: none;
  background: radial-gradient(circle, #d9f2ff, #9cd8ff);
  border: 3px solid #ffd700;
  border-radius: 15px;
  margin: 0 auto;
  touch-action: none;
}

/* INFO BAR */
#info {
  display: none;
  width: 100%;
  padding: 10px 0;
  background: rgba(0,0,0,0.3);
  border-top: 1px solid #ffd700;
  font-size: 1.2em;
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 50;
}

/* START SCREEN */
#start-screen {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9998;
}

.start-box {
  width:90%;
  max-width:420px;
  background:#fffaf2;
  border:2px solid #ffd700;
  padding:25px;
  border-radius:20px;
  color:#3a0000;
  text-align:center;
}

.start-btn {
  width:80%;
  padding:14px;
  margin-top:10px;
  font-size:1.1em;
  border:none;
  border-radius:30px;
  background:#7b0412;
  color:white;
}
.start-btn:hover {
  background:#ffd700;
  color:#000;
}

/* END SCREEN */
#fine {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.classifica-box {
  width:90%;
  max-width:420px;
  background:#fffaf2;
  color:#3a0000;
  border:2px solid #ffd700;
  border-radius:20px;
  padding:25px;
}

.btn {
  margin-top:15px;
  padding:12px 30px;
  background:#7b0412;
  border-radius:30px;
  color:white;
  cursor:pointer;
}
.btn:hover { background:#ffd700; color:black; }

table {
  width:100%;
  margin-top:10px;
}
th, td {
  padding:8px;
  border-bottom:1px solid #d7bb5f;
}
</style>
</head>

<body>

<h1>‚≠ê Giorno 5 ‚Äì Stella Furiosa PRO</h1>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">
    <h2>‚ú® Tocca la Stella Furiosa! ‚ú®</h2>
    <p>
      ‚≠ê Tocca la stella per fare punti!<br>
      ‚ùÑÔ∏è Evita il ghiaccio (perdi 1 vita)<br>
      ‚òÑÔ∏è Il meteorite fa impazzire la traiettoria<br><br>
      ‚ù§Ô∏è Hai 3 vite<br>
      ‚è≥ 30 secondi<br><br>
      üåü Aumenta la difficolt√†:<br>
      1 stella ‚Üí 2 stelle ‚Üí 4 stelle!
    </p>
    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<canvas id="game"></canvas>
<div id="info"></div>

<!-- END SCREEN -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="fine-msg"></h2>

    <h3>üèÜ Top 10</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>





<script>
/* =========================================================
   FIREBASE
========================================================= */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});

const db = firebase.database();

/* =========================================================
   NOME MASCHERATO
========================================================= */
const nameReal = localStorage.getItem("utente") || "Ospite";
const user = nameReal[0] + Math.floor(Math.random()*900+100) + nameReal.slice(1);

/* =========================================================
   CANVAS
========================================================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const W = window.innerWidth;
  const H = window.innerHeight;

  if (W < 700) {
    canvas.width = W - 20;
    canvas.height = H * 0.70;
  } else {
    canvas.width = 900;
    canvas.height = 540;
  }
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* =========================================================
   IMMAGINI
========================================================= */
const starImg = new Image();
starImg.src = "../img/stella_cartoon.png";

const iceImg = new Image();
iceImg.src = "../img/blocco_ghiaccio.png";

const meteorImg = new Image();
meteorImg.src = "../img/meteorite.png";

/* =========================================================
   GAME OBJECTS
========================================================= */

/* STELLE MULTIPLE */
let stars = [
  {
    x: 150,
    y: 150,
    size: 60,
    vx: 3,
    vy: 2,
    trail: []
  }
];

/* funzioni per aggiungere stelle */
function spawnStar() {
  stars.push({
    x: Math.random() * (canvas.width - 60),
    y: Math.random() * (canvas.height - 60),
    size: 60,
    vx: (Math.random()*4 - 2),
    vy: (Math.random()*4 - 2),
    trail: []
  });
}

/* ghiaccio */
let ices = [];

/* meteorite */
let meteor = null;

/* particelle */
let particles = [];

/* HUD */
let score = 0;
let lives = 3;
let timeLeft = 30;
let playing = false;

/* =========================================================
   PARTICELLE
========================================================= */
function createParticles(x, y, color) {
  for (let i=0; i<10; i++) {
    particles.push({
      x, y,
      vx: (Math.random()*4 - 2),
      vy: (Math.random()*4 - 2),
      alpha: 1,
      color
    });
  }
}

/* =========================================================
   MOVIMENTO STELLE
========================================================= */
function updateStars() {
  stars.forEach(s => {
    s.x += s.vx;
    s.y += s.vy;

    if (s.x < 0 || s.x + s.size > canvas.width) s.vx *= -1;
    if (s.y < 0 || s.y + s.size > canvas.height) s.vy *= -1;

    /* scia neon */
    s.trail.push({ x: s.x + 30, y: s.y + 30, alpha: 1 });
    if (s.trail.length > 15) s.trail.shift();
  });
}

/* =========================================================
   GHIACCIO
========================================================= */
function spawnIce() {
  ices.push({
    x: Math.random()*(canvas.width - 70),
    y: Math.random()*(canvas.height - 150),
    size: 55,
    hit: false
  });

  setTimeout(() => {
    ices.shift();
  }, 2500);
}

/* =========================================================
   METEORITE
========================================================= */
function spawnMeteor() {
  meteor = {
    x: canvas.width,
    y: Math.random() * (canvas.height * 0.5),
    vx: -6,
    size: 50
  };
}

function updateMeteor() {
  if (!meteor) return;

  meteor.x += meteor.vx;

  /* collisione meteorite-stella ‚Üí deviazione */
  stars.forEach(s => {
    if (
      meteor.x < s.x + s.size &&
      meteor.x + meteor.size > s.x &&
      meteor.y < s.y + s.size &&
      meteor.y + meteor.size > s.y
    ) {
      s.vx = (Math.random()*6 - 3);
      s.vy = (Math.random()*6 - 3);
      createParticles(s.x, s.y, "#ffa726");
    }
  });

  if (meteor.x < -70) meteor = null;
}

/* =========================================================
   COLLISIONI
========================================================= */
function checkCollisions() {

  /* ghiaccio ‚Üí toglie 1 vita */
  ices.forEach(i => {
    if (i.hit) return;

    stars.forEach(s => {
      if (
        s.x < i.x + i.size &&
        s.x + s.size > i.x &&
        s.y < i.y + i.size &&
        s.y + s.size > i.y
      ) {
        i.hit = true;
        lives--;
        createParticles(i.x, i.y, "#b3e5fc");

        if (lives <= 0) endGame();
      }
    });
  });
}

/* =========================================================
   DRAW
========================================================= */
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* meteorite */
  if (meteor) {
    ctx.drawImage(meteorImg, meteor.x, meteor.y, meteor.size, meteor.size);
  }

  /* scia neon per tutte le stelle */
  stars.forEach(s => {
    s.trail.forEach(t => {
      ctx.globalAlpha = t.alpha;
      ctx.fillStyle = "#fff67a";
      ctx.beginPath();
      ctx.arc(t.x, t.y, 8, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    });
  });

  /* stelle */
  stars.forEach(s => {
    ctx.drawImage(starImg, s.x, s.y, s.size, s.size);
  });

  /* ghiaccio */
  ices.forEach(i => {
    ctx.drawImage(iceImg, i.x, i.y, i.size, i.size);
  });

  /* particelle */
  particles.forEach(p => {
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, 5, 5);
    ctx.globalAlpha = 1;
  });

  /* HUD */
  document.getElementById("info").textContent =
    `‚≠ê ${score} | ‚ù§Ô∏è ${lives} | ‚è≥ ${timeLeft}s`;
}

/* =========================================================
   UPDATE LOOP
========================================================= */
function update() {
  updateStars();
  updateMeteor();
  checkCollisions();

  /* particles update */
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.alpha -= 0.02;
  });
  particles = particles.filter(p => p.alpha > 0);

  draw();

  if (playing) requestAnimationFrame(update);
}

/* =========================================================
   CLICK STELLA (mouse + touch)
========================================================= */
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  stars.forEach(s => {
    if (
      mx >= s.x &&
      mx <= s.x + s.size &&
      my >= s.y &&
      my <= s.y + s.size
    ) {
      score += 5;
      createParticles(s.x, s.y, "#fff176");
    }
  });
});

/* =========================================================
   TIMER CON AUMENTO DIFFICOLT√Ä
========================================================= */
function startTimer() {
  const t = setInterval(() => {
    if (!playing) return clearInterval(t);

    timeLeft--;

    /* AUMENTO DIFFICOLT√Ä */
    if (timeLeft === 20 && stars.length < 2) {
      spawnStar();
    }

    if (timeLeft === 10 && stars.length < 4) {
      spawnStar();
      spawnStar();
      spawnStar();
    }

    if (timeLeft <= 0) {
      clearInterval(t);
      endGame();
    }
  },1000);
}
</script>




<script>
/* =========================================================
   START GAME
========================================================= */
document.getElementById("btn-start").onclick = () => {
  document.getElementById("start-screen").style.display = "none";

  canvas.style.display = "block";
  document.getElementById("info").style.display = "block";

  playing = true;

  startTimer();
  update();

  /* ghiaccio ogni 1.2s */
  setInterval(() => {
    if (playing) spawnIce();
  }, 1200);

  /* meteorite ogni ~2.5s */
  setInterval(() => {
    if (playing && Math.random() < 0.4) spawnMeteor();
  }, 2500);
};

/* CLASSIFICA DIRETTA (dal menu iniziale) */
document.getElementById("btn-top10").onclick = () => {
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  loadTop10();
};

/* =========================================================
   SALVATAGGIO PUNTEGGIO
========================================================= */
function saveScore() {
  db.ref("punteggi/giorno5").push({
    nome: user,
    punti: score,
    timestamp: Date.now()
  }).then(loadTop10);
}

/* =========================================================
   CARICA TOP 10
========================================================= */
function loadTop10() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno5")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {
      let arr = [];
      snap.forEach(c => arr.push(c.val()));
      arr.sort((a,b)=> b.punti - a.punti);

      arr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* =========================================================
   FINE PARTITA
========================================================= */
function endGame() {
  playing = false;

  canvas.style.display = "none";
  document.getElementById("info").style.display = "none";

  document.getElementById("fine").style.display = "flex";

  document.getElementById("fine-msg").innerHTML =
    `‚≠ê Hai totalizzato <b>${score}</b> punti!`;

  saveScore();
}

/* Riprova */
document.getElementById("retry-btn").onclick = () => {
  location.reload();
};
</script>

</body>
</html>
