<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚≠ê Giorno 5 ‚Äì Stella Furiosa</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  text-align: center;
  overflow: hidden;
  height: 100vh;

  background: #7b0412 url("../img/sfondo_neve.jpg") center/cover no-repeat fixed;
  background-blend-mode: darken;
}

h1 {
  margin-top: 10px;
  color: #ffd700;
  text-shadow: 2px 2px 4px #000;
}

canvas {
  display: none;
  background: url("../img/sfondo_neve.jpg") center/cover;
  border: 3px solid #ffd700;
  border-radius: 15px;
  margin: 10px auto;
  touch-action: none;
  box-shadow: 0 0 20px #000;
}

#info {
  display: none;
  width: 100%;
  padding: 10px 0;
  font-size: 1.2em;
  background: rgba(0,0,0,0.45);
  border-top: 1px solid #ffd700;
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 50;
}

#panel {
  width: 90%;
  max-width: 420px;
  margin: 20px auto;
  background: #fffaf2;
  border: 2px solid #ffd700;
  border-radius: 20px;
  padding: 20px;
  color: #3a0000;
  box-shadow: 0 0 20px #000;
}

.btn {
  width: 80%;
  padding: 14px;
  margin-top: 10px;
  font-size: 1.1em;
  border: none;
  border-radius: 30px;
  background: #7b0412;
  color: white;
  cursor: pointer;
}
.btn:hover { background: #ffd700; color:#000; }

#fine {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.classifica-box {
  width:90%;
  max-width:420px;
  background:#fffaf2;
  border:2px solid #ffd700;
  border-radius:20px;
  padding:25px;
  color:#3a0000;
  box-shadow: 0 0 20px #000;
}

table {
  width:100%;
  margin-top:10px;
}
th, td {
  padding:8px;
  border-bottom:1px solid #d7bb5f;
  text-align:center;
}
</style>
</head>

<body>

<h1>‚≠ê Giorno 5 ‚Äì Stella Furiosa PRO</h1>

<div id="panel">
  <h2>‚ú® Come si gioca ‚ú®</h2>
  <p>
    ‚≠ê Clicca la stella per fare punti!<br>
    ‚ùÑÔ∏è Non cliccare il ghiaccio ‚Äì perdi 1 vita.<br>
    ‚òÑÔ∏è Il meteorite fa impazzire le stelle!<br><br>
    ‚è≥ Tempo: 30 secondi<br>
    ‚ù§Ô∏è Vite: 3<br>
  </p>

  <button id="btn-start" class="btn">‚ñ∂Ô∏è INIZIA</button>
  <button id="btn-top10" class="btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
</div>

<canvas id="game"></canvas>
<div id="info"></div>

<div id="fine">
  <div class="classifica-box">
    <h2 id="fine-msg"></h2>

    <h3>üèÜ Top 10</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Calendario</a>
  </div>
</div>

<script>
/* =========================================================
   FIREBASE
========================================================= */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

/* =========================================================
   NOME (MASCHERATO)
========================================================= */
const realName = localStorage.getItem("utente") || "Ospite";
const user = realName[0] + Math.floor(Math.random()*900+100) + realName.slice(1);

/* =========================================================
   CANVAS
========================================================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const W = window.innerWidth;
  const H = window.innerHeight;

  if(W < 700){
    canvas.width = W - 20;
    canvas.height = H * 0.70;
  } else {
    canvas.width = 900;
    canvas.height = 540;
  }
}
resizeCanvas();

/* =========================================================
   IMMAGINI (percorsi corretti)
========================================================= */
const starImg = new Image();
starImg.src = "../img/stella_cartoon.png";

const iceImg = new Image();
iceImg.src = "../img/blocco_ghiaccio.png";

const meteorImg = new Image();
meteorImg.src = "../img/meteorite.png";

/* =========================================================
   OGGETTI
========================================================= */
let stars = [
  { x:150, y:150, size:60, vx:2.5, vy:2.5, trail:[], hitbox:85 }
];

function spawnStar(){
  stars.push({
    x:Math.random()*(canvas.width-60),
    y:Math.random()*(canvas.height-60),
    size:60,
    vx:(Math.random()*2+1.5),
    vy:(Math.random()*2+1.5),
    trail:[],
    hitbox:85
  });
}

let ices=[];
let meteor=null;
let particles=[];
let score=0;
let lives=3;
let timeLeft=30;
let playing=false;

/* =========================================================
   HITBOX MIGLIORATA (OPZIONE C)
========================================================= */
function isHit(mx,my,s){
  return (
    mx >= s.x - (s.hitbox - s.size)/2 &&
    mx <= s.x + s.size + (s.hitbox - s.size)/2 &&
    my >= s.y - (s.hitbox - s.size)/2 &&
    my <= s.y + s.size + (s.hitbox - s.size)/2
  );
}

/* =========================================================
   CLICK
========================================================= */
canvas.addEventListener("click", e=>{
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  stars.forEach(s=>{
    if(isHit(mx,my,s)){
      score += 5;
      particles.push({x:s.x,y:s.y,alpha:1});
    }
  });

  ices.forEach(i=>{
    if(mx>=i.x && mx<=i.x+i.size && my>=i.y && my<=i.y+i.size){
      lives--;
      if(lives<=0) endGame();
    }
  });
});

/* =========================================================
   MOVIMENTO
========================================================= */
function updateStars(){
  stars.forEach(s=>{
    s.x += s.vx;
    s.y += s.vy;

    if(s.x<0 || s.x+s.size>canvas.width) s.vx*=-1;
    if(s.y<0 || s.y+s.size>canvas.height) s.vy*=-1;
  });
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  stars.forEach(s=> ctx.drawImage(starImg,s.x,s.y,s.size,s.size));
  ices.forEach(i=> ctx.drawImage(iceImg,i.x,i.y,i.size,i.size));
  if(meteor) ctx.drawImage(meteorImg,meteor.x,meteor.y,meteor.size,meteor.size);

  document.getElementById("info").textContent =
    `‚≠ê ${score} | ‚ù§Ô∏è ${lives} | ‚è≥ ${timeLeft}s`;
}

function update(){
  updateStars();
  if(playing) requestAnimationFrame(update);
  draw();
}

/* =========================================================
   TIMER
========================================================= */
function startTimer(){
  const t=setInterval(()=>{
    if(!playing) return clearInterval(t);
    timeLeft--;

    if(timeLeft===20) spawnStar();
    if(timeLeft===10){ spawnStar(); spawnStar(); spawnStar(); }

    if(timeLeft<=0){
      clearInterval(t);
      endGame();
    }
  },1000);
}

/* =========================================================
   START
========================================================= */
document.getElementById("btn-start").onclick=()=>{
  document.getElementById("panel").style.display="none";
  canvas.style.display="block";
  document.getElementById("info").style.display="block";

  playing=true;
  startTimer();
  update();
};

/* =========================================================
   CLASSIFICA
========================================================= */
document.getElementById("btn-top10").onclick=()=>{
  document.getElementById("panel").style.display="none";
  document.getElementById("fine").style.display="flex";
  loadTop10();
};

function loadTop10(){
  const table=document.getElementById("score-table");
  table.innerHTML="<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno5")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value",snap=>{
      let arr=[];
      snap.forEach(c=>arr.push(c.val()));
      arr.sort((a,b)=> b.punti - a.punti);

      arr.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* =========================================================
   GAME OVER
========================================================= */
function endGame(){
  playing=false;
  canvas.style.display="none";
  document.getElementById("info").style.display="none";
  document.getElementById("fine").style.display="flex";

  document.getElementById("fine-msg").innerHTML =
    `‚≠ê Hai totalizzato <b>${score}</b> punti!`;

  db.ref("punteggi/giorno5").push({
    nome:user,
    punti:score,
    timestamp:Date.now()
  });
}

/* =========================================================
   RIPROVA
========================================================= */
document.getElementById("retry-btn").onclick=()=>location.reload();
</script>

</body>
</html>

