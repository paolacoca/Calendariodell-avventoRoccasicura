<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚≠ê Giorno 5 ‚Äì Stella Furiosa</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  text-align: center;
  overflow-x: hidden;
  background: #7b0412 url("../img/sfondo_neve.jpg") center/cover no-repeat fixed;
  background-blend-mode: darken;
}

h1 {
  margin-top: 10px;
  color: #ffd700;
  text-shadow: 2px 2px 4px #000;
}

/* CANVAS */
canvas {
  display: none;
  background: url("../img/sfondo_neve.jpg") center/cover;
  border: 3px solid #ffd700;
  border-radius: 15px;
  margin: 20px auto;
  touch-action: none;
  box-shadow: 0 0 20px #000;
}

/* INFO BAR */
#info {
  display: none;
  width: 100%;
  padding: 10px 0;
  font-size: 1.2em;
  background: rgba(0,0,0,0.45);
  border-top: 1px solid #ffd700;
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 50;
}

/* START PANEL */
#panel {
  width: 90%;
  max-width: 420px;
  margin: 20px auto;
  background: #fffaf2;
  border: 2px solid #ffd700;
  border-radius: 20px;
  padding: 20px;
  color: #3a0000;
  box-shadow: 0 0 20px #000;
}

.btn {
  width: 80%;
  padding: 14px;
  margin-top: 10px;
  font-size: 1.1em;
  border: none;
  border-radius: 30px;
  background: #7b0412;
  color: white;
  cursor: pointer;
}
.btn:hover { background: #ffd700; color: #000; }

/* POPUP FINALE (IDENTICO AL GIORNO 1) */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(4px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
}

.classifica-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
  animation: popup .4s ease-out;
}

@keyframes popup {
  from { transform: scale(.7); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

table {
  width: 100%;
  margin-top: 15px;
}
th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #d7bb5f;
}

/* BOTTONI FINALI COME GIORNO 1 */
.btn-row {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 25px;
}

.btn-small {
  padding: 12px 25px;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  background: #b30d0d;
  color: white;
}
.btn-small:hover {
  background: #ffd700;
  color: #000;
}
</style>
</head>

<body>

<h1>‚≠ê Giorno 5 ‚Äì Stella Furiosa</h1>

<div id="panel">
  <h2>‚ú® Come si gioca ‚ú®</h2>
  <p>
    ‚≠ê Clicca la stella per fare punti!<br>
    ‚ùÑÔ∏è Non cliccare il ghiaccio ‚Äì perdi 1 vita.<br>
    ‚òÑÔ∏è Il meteorite fa impazzire le stelle!<br><br>
    ‚è≥ Tempo: 30 secondi<br>
    ‚ù§Ô∏è Vite: 3<br>
  </p>

  <button id="btn-start" class="btn">‚ñ∂Ô∏è INIZIA</button>
  <button id="btn-top10" class="btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
</div>

<canvas id="game"></canvas>
<div id="info"></div>

<div id="fine">
  <div class="classifica-box">

    <h2 id="fine-msg"></h2>
    <h3>üèÜ Top 10 ‚Äì Stella Furiosa</h3>

    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <div class="btn-row">
      <button id="retry-btn" class="btn-small">üîÑ Riprova</button>
      <a href="../calendario.html" class="btn-small">‚¨Ö Calendario</a>
    </div>

  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

/* NOME MASCHERATO */
// 'real' √® il nome utente reale
const real = localStorage.getItem("utente") || "Ospite";
// 'user' √® il nome mascherato usato nel gioco
const user = real[0] + Math.floor(Math.random()*900+100) + real.slice(1);

/* VARIABILI PER GLI INTERVALS (NUOVO) */
let iceInterval, meteorInterval; 


/* CANVAS SETUP */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  if(window.innerWidth < 700){
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight * 0.65;
  } else {
    canvas.width = 950;
    canvas.height = 550;
  }
}
resizeCanvas();

/* IMMAGINI */
const starImg = new Image(); starImg.src = "../img/stella_cartoon.png";
const iceImg = new Image(); iceImg.src = "../img/blocco_ghiaccio.png";
const meteorImg = new Image(); meteorImg.src = "../img/meteorite.png";

/* OGGETTI */
let stars = [
  { x:150, y:150, size:70, vx:3, vy:2, trail:[] }
];
let ices = [];
let meteor = null;
let particles = [];
let score = 0;
let lives = 3;
let timeLeft = 30;
let playing = false;

/* PARTICELLE */
function createParticles(x,y,color){
  for(let i=0;i<10;i++){
    particles.push({
      x,y,
      vx:(Math.random()*4-2),
      vy:(Math.random()*4-2),
      alpha:1,
      color
    });
  }
}

/* UPDATE STELLE */
function updateStars(){
  stars.forEach(s=>{
    s.vx *= 1.002;
    s.vy *= 1.002;

    s.x += s.vx;
    s.y += s.vy;

    if(s.x < 0 || s.x+s.size > canvas.width) s.vx *= -1;
    if(s.y < 0 || s.y+s.size > canvas.height) s.vy *= -1;

    s.trail.push({x:s.x+s.size/2, y:s.y+s.size/2, alpha:1});
    if(s.trail.length > 15) s.trail.shift();
  });
}

/* GHIACCIO */
function spawnIce(){
  ices.push({
    x: Math.random()*(canvas.width-70),
    y: Math.random()*(canvas.height-150),
    size: 60
  });
  setTimeout(()=>ices.shift(),2500);
}

/* METEORITE */
function spawnMeteor(){
  meteor = {
    x: canvas.width,
    y: Math.random()*(canvas.height*0.5),
    vx: -5,
    size: 65
  };
}

function updateMeteor(){
  if(!meteor) return;

  meteor.x += meteor.vx;

  stars.forEach(s=>{
    if(
      meteor.x < s.x+s.size &&
      meteor.x+meteor.size > s.x &&
      meteor.y < s.y+s.size &&
      meteor.y+meteor.size > s.y
    ){
      s.vx = (Math.random()*6-3);
      s.vy = (Math.random()*6-3);
      createParticles(s.x,s.y,"#ffa726");
    }
  });

  if(meteor.x < -80) meteor = null;
}

/* CLICK HANDLING (LOGICA MODIFICATA PER EVITARE DOPPIA INTERAZIONE) */
canvas.addEventListener("click", e=>{
  const r = canvas.getBoundingClientRect();
  const mx = e.clientX - r.left;
  const my = e.clientY - r.top;
  
  let interactionHandled = false;

  // 1. Priorit√† al Ghiaccio (se un ghiaccio viene toccato, si perde la vita e si ignora la stella)
  for (let i = 0; i < ices.length; i++) {
    const ice = ices[i];
    if (mx >= ice.x && mx <= ice.x + ice.size && my >= ice.y && my <= ice.y + ice.size) {
      lives--;
      if (lives <= 0) endGame();
      interactionHandled = true;
      break; 
    }
  }

  if (interactionHandled) return;

  // 2. Stelle (solo se il ghiaccio non √® stato toccato)
  stars.forEach(s=>{
    if(mx>=s.x && mx<=s.x+s.size && my>=s.y && my<=s.y+s.size){
      score += 5;
      createParticles(s.x,s.y,"#fff176");
    }
  });
});

/* DRAW */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(meteor) ctx.drawImage(meteorImg, meteor.x, meteor.y, meteor.size, meteor.size);

  stars.forEach(s=>{
    s.trail.forEach(t=>{
      ctx.globalAlpha = t.alpha;
      ctx.fillStyle = "#fff67a";
      ctx.beginPath();
      ctx.arc(t.x, t.y, 7, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    });
  });

  stars.forEach(s=> ctx.drawImage(starImg, s.x, s.y, s.size, s.size));
  ices.forEach(i=> ctx.drawImage(iceImg, i.x, i.y, i.size, i.size));

  particles.forEach(p=>{
    p.x += p.vx;
    p.y += p.vy;
    p.alpha -= 0.02;
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x,p.y,5,5);
    ctx.globalAlpha = 1;
  });
  particles = particles.filter(p=>p.alpha>0);

  document.getElementById("info").textContent =
    `‚≠ê ${score} | ‚ù§Ô∏è ${lives} | ‚è≥ ${timeLeft}s`;
}

/* FRAME LOOP */
function update(){
  updateStars();
  updateMeteor();
  draw();
  if(playing) requestAnimationFrame(update);
}

/* TIMER */
let mainTimer;
function startTimer(){
  mainTimer = setInterval(()=>{
    if(!playing) return clearInterval(mainTimer);

    timeLeft--;

    if(timeLeft === 20) stars.push({x:200,y:100,size:70,vx:3,vy:2,trail:[]});
    if(timeLeft === 10) stars.push({x:300,y:120,size:70,vx:4,vy:3,trail:[]});

    if(timeLeft <= 0){
      clearInterval(mainTimer);
      endGame();
    }
  },1000);
}

/* START */
document.getElementById("btn-start").onclick = ()=>{
  document.getElementById("panel").style.display = "none";
  canvas.style.display = "block";
  document.getElementById("info").style.display = "block";

  playing = true;
  startTimer();
  
  // Assegna gli intervalli alle variabili (NUOVO)
  iceInterval = setInterval(()=>{ if(playing) spawnIce(); },1200);
  meteorInterval = setInterval(()=>{ if(playing && Math.random() < 0.55) spawnMeteor(); },3000);

  update();
};

/* APRI CLASSIFICA */
document.getElementById("btn-top10").onclick = ()=>{
  document.getElementById("panel").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  loadTop10();
};

/* CARICA CLASSIFICA TOP 10 (LETTURA DA classifica_max) */
function loadTop10(){
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  // Legge dalla nuova cartella classifica_max
  db.ref("classifica_max/giorno5") 
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap=>{
      let list = [];
      snap.forEach(child => list.push(child.val()));
      // La classifica usa il nome REALE e non il mascherato
      list.sort((a,b)=> b.punti - a.punti);

      list.forEach(r=>{
        const tr = document.createElement("tr");
        // Mostra il nome reale, o il nome mascherato se salvato
        const nomeDisplay = r.nome_mascherato || r.nome; 
        tr.innerHTML = `<td>${nomeDisplay}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* GAME OVER (LOGICA DI SALVATAGGIO MODIFICATA) */
function endGame(){
  playing = false;
  
  // Ferma tutti gli setInterval attivi (NUOVO)
  clearInterval(mainTimer);
  clearInterval(iceInterval);
  clearInterval(meteorInterval);

  canvas.style.display = "none";
  document.getElementById("info").style.display = "none";
  document.getElementById("fine").style.display = "flex";

  document.getElementById("fine-msg").innerHTML =
    `‚≠ê Hai totalizzato <b>${score}</b> punti!`;

  // --- LOGICA SALVATAGGIO CLASSIFICA ---
  const userRef = db.ref("classifica_max/giorno5").child(real); 

  // 1. Controlla il punteggio massimo esistente per l'utente 'real'
  userRef.once("value", snapshot => {
    const record = snapshot.val();
    const currentMaxScore = record ? record.punti : 0;

    // 2. Salva solo se il punteggio attuale (score) √® maggiore
    if (score > currentMaxScore) {
      userRef.set({
        nome: real, // Chiave
        punti: Number(score),
        timestamp: Date.now(),
        nome_mascherato: user // Salviamo anche il nome mascherato per la visualizzazione
      }).then(() => {
        // Se il salvataggio √® avvenuto, ricarica la classifica
        loadTop10(); 
      });
    } else {
      // Se non √® stato un record personale, mostra comunque la classifica
      loadTop10();
    }
  });
  // --- FINE LOGICA SALVATAGGIO ---
}

/* RIPROVA */
document.getElementById("retry-btn").onclick = ()=> location.reload();
</script>

<script src="https://cdn.counter.dev/script.js"
        data-id="9d666b79-dc20-433b-8015-ac699700813e"
        data-utcoffset="1"></script>

</body>
</html>
