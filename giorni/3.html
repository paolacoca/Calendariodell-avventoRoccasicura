<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
    <title>üéÑ Giorno 3 ‚Äì Snowman Escape</title>

    <!-- FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

    <style>
/* --------------------------
   STILE GENERALE
-------------------------- */
body {
    margin: 0;
    padding: 0;
    background: #7b0412;
    color: white;
    font-family: 'Ubuntu', sans-serif;
    text-align: center;
}

.titolo-gioco {
    font-size: 26px;
    margin-top: 10px;
    color: #ffd700;
}

/* CANVAS CENTRALIZZATO */
.canvas-container {
    width: 360px;
    height: 640px;
    margin: 0 auto;
    border: 2px solid rgba(255, 215, 0, 0.4);
    border-radius: 10px;
}

canvas {
    width: 360px;
    height: 640px;
    display: block;
    background: #bde0fe;
}

/* BOTTONI */
.controls {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.btn-spara {
    background: #ffd700;
    color: #7b0412;
    font-size: 22px;
    font-weight: bold;
    border: 3px solid #fff3b0;
    border-radius: 14px;
    padding: 12px 20px;
    width: 85%;
    margin: 0 auto;
    cursor: pointer;
}

.btn-regalo {
    background: #ffffff;
    color: #7b0412;
    font-size: 20px;
    font-weight: bold;
    border: 3px solid #ffd700;
    border-radius: 14px;
    padding: 10px 20px;
    width: 85%;
    margin: 0 auto;
    cursor: pointer;
    opacity: 0.4;
}

.btn-regalo.enabled {
    opacity: 1;
}

/* HUD */
.hud {
    margin-top: 12px;
    font-size: 20px;
    display: flex;
    justify-content: space-around;
}

/* POPUP ISTRUZIONI */
.modal {
    position: fixed;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.75);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    color: #7b0412;
    width: 85%;
    padding: 20px;
    border-radius: 12px;
    border: 3px solid #ffd700;
    text-align: center;
}

.btn-start {
    background: #ffd700;
    color: #7b0412;
    padding: 12px 20px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
}

/* CLASSIFICA */
.leaderboard {
    margin-top: 15px;
}

.leaderboard ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.leaderboard li {
    background: rgba(255,255,255,0.18);
    margin: 4px auto;
    width: 85%;
    padding: 6px;
    border-radius: 6px;
}
    </style>
</head>

<body>

<!-- POPUP ISTRUZIONI -->
<div id="modalIstruzioni" class="modal">
    <div class="modal-content">
        <h2>üéÆ Come si gioca?</h2>
        <p>üëÜ Tieni premuto sullo schermo per salire.<br>
           üëá Lascia per scendere.<br><br>
           üéØ Premi <b>SPARA</b> per lanciare le bamboline.<br>
           ‚ùÑ Se colpisci un pupazzo ‚Üí <b>+50 punti</b>.<br><br>
           üéÅ Se appare un regalo puoi attivare il bonus.<br>
           üé£ Attenzione! La rete ‚Üí <b>-30 punti</b> se prende un pupazzo.<br><br>
           ‚ù§Ô∏è Hai 3 vite.</p>

        <button id="btnStart" class="btn-start">INIZIA!</button>
    </div>
</div>

<h1 class="titolo-gioco">üéÑ Giorno 3 ‚Äì Snowman Escape</h1>

<div class="canvas-container">
    <canvas id="gameCanvas" width="360" height="640"></canvas>
</div>

<div class="controls">
    <button id="btnSpara" class="btn-spara">SPARA!</button>
    <button id="btnRegalo" class="btn-regalo" disabled>PRENDI IL REGALO!</button>
</div>

<div class="hud">
    <span id="score">Punteggio: 0</span>
    <span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
</div>

<!-- CLASSIFICA -->
<div class="leaderboard">
    <h3>üèÜ Top 10 Globale</h3>
    <ul id="listaClassifica"></ul>
</div>


<script>
/* -------------------------------
   FIREBASE CONFIG
-------------------------------- */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.firebasestorage.app",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

/* -------------------------------
   VARIABILI DI GIOCO
-------------------------------- */
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");

const W=canvas.width;
const H=canvas.height;

let running=false; // parte solo quando premi INIZIA

const btnSpara=document.getElementById("btnSpara");
const btnRegalo=document.getElementById("btnRegalo");
const scoreElement=document.getElementById("score");
const livesElement=document.getElementById("lives");

const modal=document.getElementById("modalIstruzioni");
const btnStart=document.getElementById("btnStart");

/* IMMAGINI */
const imgBabbo=new Image(); imgBabbo.src="./img/babbo_3.png";
const imgSnowman=new Image(); imgSnowman.src="./img/snowman.png";
const imgGift=new Image(); imgGift.src="./img/gift.png";

const projectileImgs=[
    Object.assign(new Image(),{src:"./img/b1.png"}),
    Object.assign(new Image(),{src:"./img/b2.png"}),
    Object.assign(new Image(),{src:"./img/b3.png"})
];

let babbo={x:40,y:H/2,w:80,h:80,vy:0};

let snowmen=[];
let gifts=[];
let projectiles=[];

let reteAttiva=false;
let reteTimer=0;

let score=0;
let lives=3;

let touching=false;

/* TOUCH + MOUSE */
canvas.addEventListener("touchstart",()=>touching=true);
canvas.addEventListener("touchend",()=>touching=false);
canvas.addEventListener("mousedown",()=>touching=true);
canvas.addEventListener("mouseup",()=>touching=false);

/* MOVIMENTO BABBO */
function moveBabbo(){
    babbo.vy= touching ? -3.5 : 3.5;
    babbo.y+=babbo.vy;
    if(babbo.y<0) babbo.y=0;
    if(babbo.y+babbo.h>H) babbo.y=H-babbo.h;
}

/* CREA PUPAZZO */
function spawnSnowman(){
    snowmen.push({
        x:W+40,
        y:Math.random()*(H-100),
        w:90,h:90,
        speed:2
    });
}

/* CREA REGALO */
function spawnGift(){
    gifts.push({
        x:W+40,
        y:Math.random()*(H-100),
        w:60,h:60,
        speed:2
    });
}

/* SPARA BAMBOLINA */
btnSpara.addEventListener("click",()=>{
    const img=projectileImgs[Math.floor(Math.random()*projectileImgs.length)];
    projectiles.push({
        x:babbo.x+babbo.w,
        y:babbo.y+babbo.h/2-15,
        w:40,h:40,
        speed:6,
        img:img
    });
});

/* BOTTONE REGALO */
btnRegalo.addEventListener("click",()=>{
    if(!reteAttiva) return;
    reteTimer=60;
});

/* COLLISIONE */
function rectCollision(a,b){
    return(
        a.x<b.x+b.w &&
        a.x+a.w>b.x &&
        a.y<b.y+b.h &&
        a.y+a.h>b.y
    );
}

/* SALVA SU FIREBASE */
function salvaPunteggio(){
    db.ref("punteggi/giorno3").push({
        punteggio: score,
        data: Date.now()
    });
}

/* CARICA CLASSIFICA */
function caricaClassifica(){
    const lista=document.getElementById("listaClassifica");
    db.ref("punteggi/giorno3")
    .orderByChild("punteggio")
    .limitToLast(10)
    .once("value",snap=>{
        let arr=[];
        snap.forEach(c=>arr.push(c.val().punteggio));
        arr.reverse();

        lista.innerHTML="";
        arr.forEach((p,i)=>{
            lista.innerHTML+=`<li>${i+1}) ${p} punti</li>`;
        });
    });
}

/* GAME OVER */
function gameOver(){
    running=false;
    salvaPunteggio();
    caricaClassifica();

    ctx.fillStyle="rgba(0,0,0,0.6)";
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle="white";
    ctx.font="32px Ubuntu";
    ctx.fillText("GAME OVER",W/2-90,H/2);
}

/* UPDATE */
let snowTimer=0;
let giftTimer=0;

function update(){
    if(!running) return;

    ctx.clearRect(0,0,W,H);

    moveBabbo();
    ctx.drawImage(imgBabbo,babbo.x,babbo.y,babbo.w,babbo.h);

    /* PUPAZZI */
    snowTimer++;
    if(snowTimer>80){
        spawnSnowman();
        snowTimer=0;
    }

    snowmen.forEach((s,si)=>{
        s.x-=s.speed;
        ctx.drawImage(imgSnowman,s.x,s.y,s.w,s.h);

        if(rectCollision(babbo,s)){
            lives--;
            livesElement.textContent="‚ù§Ô∏è".repeat(lives)+"üñ§".repeat(3-lives);
            snowmen.splice(si,1);
            if(lives<=0) return gameOver();
        }

        if(reteTimer>0){
            let reteArea={x:babbo.x+babbo.w+10,y:babbo.y,w:120,h:babbo.h};
            ctx.strokeStyle="rgba(255,255,255,0.6)";
            ctx.strokeRect(reteArea.x,reteArea.y,reteArea.w,reteArea.h);

            if(rectCollision(reteArea,s)){
                score-=30;
                if(score<0) score=0;
                snowmen.splice(si,1);
                scoreElement.textContent="Punteggio: "+score;
            }
        }
    });

    if(reteTimer>0){
        reteTimer--;
        if(reteTimer==0){
            reteAttiva=false;
            btnRegalo.disabled=true;
            btnRegalo.classList.remove("enabled");
        }
    }

    /* REGALI */
    giftTimer++;
    if(giftTimer>200){
        spawnGift();
        giftTimer=0;
    }

    gifts.forEach((g,gi)=>{
        g.x-=g.speed;
        ctx.drawImage(imgGift,g.x,g.y,g.w,g.h);

        if(rectCollision(babbo,g)){
            gifts.splice(gi,1);
            reteAttiva=true;
            btnRegalo.disabled=false;
            btnRegalo.classList.add("enabled");
        }
    });

    /* PROIETTILI */
    projectiles.forEach((p,pi)=>{
        p.x+=p.speed;
        ctx.drawImage(p.img,p.x,p.y,p.w,p.h);

        if(p.x>W) projectiles.splice(pi,1);

        snowmen.forEach((s,si)=>{
            if(rectCollision(p,s)){
                score+=50;
                scoreElement.textContent="Punteggio: "+score;
                snowmen.splice(si,1);
                projectiles.splice(pi,1);
            }
        });
    });

    requestAnimationFrame(update);
}

/* START GAME */
btnStart.addEventListener("click",()=>{
    modal.style.display="none";
    running=true;
    update();
});

/* MOSTRA CLASSIFICA ALL'AVVIO */
caricaClassifica();
</script>

</body>
</html>
