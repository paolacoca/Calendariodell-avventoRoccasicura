<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">

<title>üéÑ Giorno 3 ‚Äì Snowman Escape</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  text-align: center;
  color: white;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 15px;
  font-size: 2rem;
}

/* HUD */
#hud {
  margin-top: 8px;
  font-size: 1.4rem;
  font-weight: bold;
}

/* CANVAS */
.canvas-wrapper {
  width: 100%;
  max-width: 520px;
  margin: 12px auto;
}

#gameCanvas {
  display: none;
  width: 100%;
  border: 3px solid #ffd700;
  border-radius: 14px;
  background: black;
}

/* NEVE */
.neve {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 8;
}

/* BOTTONI */
.controls {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  gap: 12px;
  width: 100%;
  max-width: 520px;
  margin-left: auto;
  margin-right: auto;
}

.btn {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  border: 3px solid #fff3b0;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
}

#btnRete {
  background: white;
  color: #7b0412;
  border: 3px solid #ffd700;
}

#btnSpara {
  background: #ffd700;
  color: #7b0412;
}

/* START SCREEN */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 92%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
  font-size: 1.15rem;
}

.start-btn {
  width: 85%;
  margin-top: 10px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.2rem;
  cursor: pointer;
  background: #7b0412;
  color: white;
  font-weight: bold;
  border: none;
}

.start-btn:hover {
  background: #ffd700;
  color: #400000;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
  animation: zoom 1s ease;
}

@keyframes zoom {
  0% { opacity: 0; transform: scale(0.4); }
  50% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(2); }
}

/* END SCREEN */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

table {
  width: 100%;
  margin-top: 15px;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 3 ‚Äì Snowman Escape</h1>

<div id="hud">‚ù§Ô∏è 3 | ‚≠ê 0</div>

<div class="canvas-wrapper">
  <canvas id="gameCanvas"></canvas>
</div>

<canvas id="snow" class="neve"></canvas>

<div class="controls">
  <button id="btnRete" class="btn">üï∏ PRENDI IL REGALO</button>
  <button id="btnSpara" class="btn">üéØ SPARA!</button>
</div>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">

    <p><b>Insieme a Babbo, cattura i regali e distruggi i pupazzi di neve che ti ostacolano il cammino!</b></p>

    <h3>‚≠ê Sistema Punteggio</h3>

    <p style="text-align:left; line-height:1.45;">
      üéÅ <b>Pacco catturato</b> ‚Üí <b>+50 punti</b><br>
      ‚òÉÔ∏è <b>Snowman sparato</b> ‚Üí <b>+15 punti</b><br>
      üí• <b>Pacco colpito da sparo</b> ‚Üí <b>-5 punti</b><br>
      üï∏ <b>Snowman catturato con la rete</b> ‚Üí <b>-1 vita</b><br>
      ‚òÉÔ∏è‚û°Ô∏èüéÖ <b>Snowman tocca Babbo</b> ‚Üí <b>-1 vita</b>
    </p>

    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>

  </div>
</div>

<!-- END SCREEN -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>
    <h3>üèÜ Top 10</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>
    <button id="retry-btn" class="start-btn" style="background:#d41e1e; width:80%;">üîÑ Riprova</button>
    <a href="../calendario.html" class="start-btn" style="width:80%; background:#ffd700;color:#400000;">‚¨Ö Torna al Calendario</a>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

const nomeReale = localStorage.getItem("utente") || "Ospite";
const nomeMascherato = nomeReale[0] + Math.floor(Math.random()*900+100) + nomeReale.slice(1);

/* CANVAS */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 520);
  const h = Math.floor(w * 0.6); 
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* IMMAGINI */
const imgBabbo = new Image();
imgBabbo.src = "./img/babbo_sacco.png";

const imgSnowman = new Image();
imgSnowman.src = "./img/snowman.png";

const imgGift    = new Image();
imgGift.src = "./img/gift.png";

const imgRete    = new Image();
imgRete.src = "./img/rete.png";

const sfondo = new Image();
sfondo.src = "./img/rocca.png";

/* Palline */
const pallineImgs = ["./img/b1.png","./img/b2.png","./img/b3.png"].map(src=>{
  let im = new Image();
  im.src=src;
  return im;
});
let pallinaIndex = 0;

/* VARIABILI */
let running=false;
let lives=3;
let score=0;

/* BABBO */
let babbo={x:0,y:0,w:0,h:0};

imgBabbo.onload=()=>{
  const scale=0.36;
  babbo.w=imgBabbo.width*scale;
  babbo.h=imgBabbo.height*scale;

  babbo.x = canvas.width * 0.12;
  babbo.y = canvas.height * 0.60;
};

let oggetti=[];
let proiettili=[];
let rete=null;

function updateHUD(){
  document.getElementById("hud").textContent=`‚ù§Ô∏è ${lives} | ‚≠ê ${score}`;
}

/* OGGETTI SULLA STESSA LINEA */
function generaOggetto(){
  if(!running) return;

  const tipo = Math.random()<0.5 ? "snowman":"gift";

  oggetti.push({
    type:tipo,
    x:canvas.width+40,
    y:canvas.height*0.60,
    w:tipo==="snowman"?65:50,
    h:tipo==="snowman"?65:50,
    speed:3.2
  });
}
setInterval(generaOggetto,1200);

/* SPARA */
document.getElementById("btnSpara").addEventListener("click",()=>{
  if(!running) return;

  proiettili.push({
    x:babbo.x+babbo.w,
    y:babbo.y+10,
    w:40,h:40,
    speed:7,
    angle:0,
    img:pallineImgs[pallinaIndex]
  });

  pallinaIndex=(pallinaIndex+1)%pallineImgs.length;
});

/* RETE */
document.getElementById("btnRete").addEventListener("click",()=>{
  if(!running) return;

  rete={
    x:babbo.x+babbo.w,
    y:babbo.y,
    w:70,h:70,
    speed:4
  };
});

/* COLLISIONE */
function hit(a,b){
  return(
    a.x<b.x+b.h &&
    a.x+a.w>b.x &&
    a.y<b.y+b.h &&
    a.y+a.h>b.y
  );
}

/* GAME LOOP */
function updateGame(){
  if(!running) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.drawImage(sfondo,0,0,canvas.width,canvas.height);

  ctx.drawImage(imgBabbo,babbo.x,babbo.y,babbo.w,babbo.h);

  oggetti.forEach((o,i)=>{
    o.x-=o.speed;
    ctx.drawImage(o.type==="snowman"?imgSnowman:imgGift,o.x,o.y,o.w,o.h);

    if(hit(babbo,o)){
      if(o.type==="snowman") lives--;
      else score+=50;

      oggetti.splice(i,1);
      updateHUD();

      if(lives<=0) return gameOver();
    }

    if(o.x<-100) oggetti.splice(i,1);
  });

  proiettili.forEach((p,pi)=>{
    p.x+=p.speed;
    p.angle+=0.25;

    ctx.save();
    ctx.translate(p.x+p.w/2,p.y+p.h/2);
    ctx.rotate(p.angle);
    ctx.drawImage(p.img,-p.w/2,-p.h/2,p.w,p.h);
    ctx.restore();

    oggetti.forEach((o,oi)=>{
      if(hit(p,o)){
        if(o.type==="snowman") score+=15;
        else score-=5;

        if(score<0) score=0;

        oggetti.splice(oi,1);
        proiettili.splice(pi,1);
        updateHUD();
      }
    });

    if(p.x>canvas.width+60) proiettili.splice(pi,1);
  });

  if(rete){
    rete.x+=rete.speed;
    ctx.drawImage(imgRete,rete.x,rete.y,rete.w,rete.h);

    oggetti.forEach((o,oi)=>{
      if(hit(rete,o)){
        if(o.type==="gift") score+=50;
        else lives--;

        oggetti.splice(oi,1);
        rete=null;
        updateHUD();
      }
    });

    if(rete && rete.x>canvas.width+50) rete=null;
  }

  requestAnimationFrame(updateGame);
}

/* COUNTDOWN */
function startCountdown(cb){
  const layer=document.getElementById("countdown");
  const num=document.getElementById("countdown-number");
  let n=3;

  layer.style.display="flex";
  num.textContent=n;

  const timer=setInterval(()=>{
    n--;
    num.classList.remove("countdown-number");
    void num.offsetWidth;
    num.classList.add("countdown-number");

    if(n>0) num.textContent=n;
    else{
      num.textContent="VIA!";
      setTimeout(()=>{
        clearInterval(timer);
        layer.style.display="none";
        cb();
      },600);
    }
  },1000);
}

/* START */
function avviaGioco(){
  document.getElementById("start-screen").style.display="none";
  canvas.style.display="block";
  running=true;
  updateGame();
}
document.getElementById("btn-start").addEventListener("click",()=>{
  startCountdown(avviaGioco);
});

/* CLASSIFICA */
function caricaClassifica(){
  const table=document.getElementById("score-table");
  table.innerHTML="<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno3")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value",snap=>{
      let arr=[];
      snap.forEach(c=>arr.push(c.val()));
      arr.sort((a,b)=>b.punti-a.punti);

      arr.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

function gameOver(){
  running=false;
  document.getElementById("fine").style.display="flex";

  document.getElementById("messaggio").textContent=
    `Hai totalizzato ${score} punti!`;

  db.ref("punteggi/giorno3").push({
    nome:nomeMascherato,
    punti:score,
    timestamp:Date.now()
  });

  caricaClassifica();
}

document.getElementById("btn-top10").addEventListener("click",()=>{
  document.getElementById("start-screen").style.display="none";
  document.getElementById("fine").style.display="flex";
  caricaClassifica();
});

document.getElementById("retry-btn").addEventListener("click",()=>{
  location.reload();
});

/* NEVE */
const snow=document.getElementById("snow");
const sctx=snow.getContext("2d");

function resizeSnow(){
  snow.width=window.innerWidth;
  snow.height=window.innerHeight;
}
resizeSnow();
window.addEventListener("resize",resizeSnow);

let flakes=[];
function createFlake(){
  flakes.push({
    x:Math.random()*snow.width,
    y:-10,
    r:Math.random()*2+1,
    s:Math.random()*1+0.5
  });
}
setInterval(createFlake,100);

function updateSnow(){
  sctx.clearRect(0,0,snow.width,snow.height);

  flakes.forEach((f,i)=>{
    f.y+=f.s;
    sctx.fillStyle="white";
    sctx.beginPath();
    sctx.arc(f.x,f.y,f.r,0,Math.PI*2);
    sctx.fill();

    if(f.y>snow.height) flakes.splice(i,1);
  });

  requestAnimationFrame(updateSnow);
}
updateSnow();

</script>

<div id="countdown"><div id="countdown-number"></div></div>

</body>
</html>
